## 1.1 CPU的基本概念
计算机的控制器与运算器以及寄存器一起构成了计算机的中央处理器(CPU),  CPU具有以下四个方面的基本功能:

1. 指令控制: 对程序运行的控制。 程序由一个指令序列构成，指令之间在逻辑上相互关系无法改变，包括数据依赖性和控制依赖性,因此CPU要对程序的执行流程进行控制以保证得到正确的结果。

2. 操作控制: 对指令的各个操作步骤进行控制，一条指令的功能一般需要几个操作步骤来实现，CPU必须控制这些操作步骤的实施，例如时间控制。

3. 数据运算，包含算术运算与逻辑运算等，包括定点数，浮点数，字符数据等数据的运算，这是CPU最基本的功能。

4. 异常处理和中断处理: CPU要能够对可能出现的意外情况进行处理，例如数据运算中的溢出和外围设备的服务请求等。

此外，CPU还可以具有: 存储管理(虚拟存储器管理，存储器保护)、总线管理(对CPU所连接的系统总线的裁决)、电源功耗管理(减少CPU电源功率消耗，对供电和工作频率进行配置管理)、Cache以及其扩展功能管理等。

控制器的主要功能是控制指令执行的步骤和数据在各个部件之间的流动，包括从内存取指、计算下一条指令在内存中的地址、指令译码、产生响应的操作控制信号、流水线控制等等。

运算器接受控制器的命令进行运算操作，它是指令的执行部件，又称为功能部件，其主要功能是执行所有的算术运算和所有的逻辑运算，包括比较测试。

## 1.2 CPU的寄存器

CPU中可以有多种寄存器以存放各种信息,在CISC(Complex Instruction Set Computer)系统中一般有五种类型的寄存器:

1. 指令寄存器(IR, Instruction Register): 存放正在执行的指令, 为指令译码器提供指令信息, 指令寄存器对程序员透明，对IR的操作隐含.

2. 程序计数器(PC, Program Counter): 存放指令的地址, 从存储器中取指令时根据PC的值进行！取指后PC更新为下一条指令的地址。

3. 数据寄存器(DR, Data Register): 存放操作数、运算结果和运算的中间结果, 或者存放从存储器读取的数据和要写入存储器的数据，以减少访问存储器的次数。

4. 地址寄存器(AR, Address Register): 存放操作数地址. 在RISC(Reduced Instruction Set Computer)处理器中一般设置通用寄存器，既可以存放地址，又可以存放数据。

5. 状态寄存器(SR, Status Register): 存储运算中的状态，作为控制程序的条件。 在某些控制器中，会把反映计算机运行情况的状态代码集中在一起构成程序状态字(PSW)存储在状态寄存器中。

如果程序员可以通过汇编语言访问，称这个寄存器可见，CPU中的内部寄存器例如IR和一些存储器接口寄存器(如MAR, MDR)对程序员是不可见的。

## 2. 指令的执行与周期

程序在被执行之前装入到主存中，在程序执行的过程中，如果没有分支指令，CPU将会从主存中逐条取出指令顺序执行(取指、译码、执行、访存、写回)

1. 取指: CPU用PC寄存器保存指令的地址，每次取指后，PC更新为下一个指令字的地址，存储器访存按字进行，当指令长度大于一个字，上述过程需要重复进行。

2. 执行: 分析指令，进行译码，产生所需要的操作信号，完成指定的操作，如果参与操作的数据在存储器中，还需要形成操作数的地址，读取操作数据，最后可能还要将结果写回寄存器或者存储器，再读取下一条指令执行。

时钟周期: 计算机时钟主频的周期

机器周期: 访存寄存器及运算等基本操作的时间

指令周期: 一条指令的启动到下一条指令的启动之间的间隔时间。

在新型计算机中，机器周期一般等于一个时钟周期，也就是说一般访存和运算等操作可以在一个时钟周期内完成。

## 3 流水线技术
流水技术在计算机中用来提高指令的执行速度和数据运算的速度, 这种技术将一个计算任务分成若干个子任务,每个任务由专门的部件(流水段)处理，这些部件构成了一条流水线，各个流水段之间设有缓冲寄存器，用来暂时保存上一条流水段的处理结果。通过采用流水线技术，**不必等到上一条指令的完成就可以开始下一条指令的执行**，尽管流水线技术不能缩短一条指令执行的绝对时间，但是通过指令间的**重叠执行**方式，可以提高指令执行的速率或者吞吐率。

吞吐率(throughput): 单位时间内流水线能执行的指令数量。 吞吐率与流水的节拍时间有关。

节拍时间: 指令从一个流水段进入下一个流水段的间隔时间，或者称为流水周期。 流水线通常要求在一个统一的时钟控制下，每个流水段同步地移动，也就是各级流水段同时将指令执行的中间结果放在流水寄存器中，传递给下一个流水段。 流水周期(节拍时间)确定的方法因此是，**T = tmax + tdelay**(各个流水段处理时间的最大值加上寄存器的延迟时间)

加速比: 流水方式的工作速度与等效的顺序工作方式时间的比值

## 3.2 流水线的相关性
流水线要能够具有良好性能，必须能够畅通流动，然而，指令的并行处理方式中可能出现三种相关性: 资源相关、数据相关、控制相关。

> 1. 资源相关

多条指令在同一段时间内需要使用同一个流水级，这种现象称为资源相关。这种相关性主要是由于硬件资源不足，例如数据和指令存放在同一个存储器，而访问接口只有一个，就会发生冲突。

> 2. 数据相关

数据相关是指流水线中指令之间的数据依赖关系。 例如，一条指令的操作数是另一条指令的运算结果，则指令之间的读写存在约束关系而不再独立，这将会影响到指令的并行执行。

> 3. 控制相关

控制相关是指令序列的选择关系，后继指令的选择由前面指令执行的结果来决定。例如，对于计算机的分支结构，可能需要考虑之前指令执行对标志位的影响。

为了解决相关性的问题，需要停顿后继指令的流水执行，这就要求有硬件能够检测这种相关性，例如数据相关性可以通过比较使用的寄存器号来实现，指令间的相关性检测也可以由编译程序来实现，对存在相关性的指令，可以改变指令顺序，或者加入NOP空指令。 显然为了解决这种相关性，流水线的性能有所损失，设置专用通路，增加硬件资源可以缓解这种损失。除此之外，对于控制相关，可能会存在发现一条转移指令的时候，下一条指令已经读取进入流水线，此时这条指令就会作废，解决办法是提前执行转移指令或者对转移情况预测，分支预测电路是一个状态机，其记录了转移指令过去的转移状态以及目标地址的缓存。

**不是所有指令系统都适合于流水执行。**

