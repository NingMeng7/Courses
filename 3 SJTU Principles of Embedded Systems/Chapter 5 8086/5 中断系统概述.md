## 1. 中断概述
**中断**： 中断指的是，当CPU执行当前程序，出现某些异常事件或某种外部请求的时候，CPU暂时停止正在执行的程序，转去执行外围设备服务的程序，当外围设备服务的程序执行完之后，CPU再返回暂时停止的正在执行的程序处(断点)，继续执行原本的程序。

**中断源**: 凡是能够提出中断请求的设备或异常故障，均称为中断源
1. 外设中断源: 如键盘,打印机,磁盘,磁带等，工作中要求CPU为其服务的时候，会向CPU发送中断请求
2. 故障中断源: 当系统出现某种故障,例如存储器出错，运算溢出等，相关部件会向CPU发出中断请求,使CPU转去执行故障处理程序来解决故障
3. 软件中断源: 在程序中向CPU发出中断指令,8086中为INT指令
4. 为调试而设置的中断: 单步中断及断点中断

**中断的优先级**: 当碰到多个中断源同时请求的情况,CPU需要确定先为哪个中断源服务，及服务次序，这就要求对不同的中断请求要设置不同的优先级。当几个中断同时请求，先执行中断优先级高的中断，当执行某个中断的时候，要能响应优先级更高的中断，而屏蔽同级和优先级更低的中断。

> 1. 软件查询确定中断优先级

将各个外设的中断请求信号相或, 送到CPU的INTR端,同时把几个外设的中断请求状态位组成一个端口，由于请求信号是或关系，任一请求即会让CPU响应中断进入中断处理子函数，用软件逐位查询端口内容，查询到哪个外设就转入哪个外设的中断服务程序，这个查询的顺序就决定了优先级的高低。

> 2. 硬件查询确定中断优先级(菊花链法)

每一级的外设的对应接口连接上一个逻辑电路，构成一条链来控制中断响应信号的通路，具体地说，当任一外部设备发出中断请求，中断请求信号送到CPU的INTR端，CPU发出INTA'中断响应信号，当前一级的外设没有发出中断申请的时候，INTA'将会沿着菊花链往后摸，直到某一级外设发出了申请，这一级的逻辑电路就会堵塞INTR'信号继续向后传，这个接口收到INTA'信号后就撤销中断请求信号，并向总线发送中断类型号，使得CPU转入中断处理。 显然,**这个查询的过程决定了不同外设中断请求的优先级, 硬件路线上越接近CPU的外设接口，优先级越高。**

> 3. 中断优先级编码电路——矢量中断优先级

矢量中断优先级的设置采用中断优先级控制器来实现。 例如,具体地说，总共有四个寄存器: 中断请求寄存器，中断屏蔽寄存器，中断服务寄存器，中断类型寄存器。 外设可以给出8个中断请求IR0~IR7，送入中断请求寄存器，中断优先级管理逻辑电路判别处最高优先级的中断请求，并将其中断级转换为3位码送入中断类型寄存器的低3位和中断服务寄存器。 之后，中断优先级控制器向CPU发出中断请求信号，CPU开放中断的时候，CPU将会发出中断响应信号，开始中断处理，处理结束后，中断服务寄存器对应位清零，级别较低的中断请求才能得到请求。 用户可以设置中断屏蔽寄存器屏蔽某几位的中断请求。

**中断的嵌套**

 CPU执行某个中断的时候，允许响应优先级更高的中断请求，挂起正在处理的中断，这称为中断嵌套。多重中断响应与单级中断有几点区别:
 
 1. 加入屏蔽本级和较低级中断请求的环节, 防止中断处理的时候受到不响应的中断请求干扰，以及能够响应优先级更高的中断请求

 2. 在中断服务之前，要保护现场，屏蔽本级与更低级中断，然后开中断，这是为了能够响应更高优先级的中断以及能够在之后返回断点。
 
 3. 在中断服务函数结束之后，为了在恢复现场过程不被任何中断请求干扰，应当关中断。
 
 4. 恢复现场之后，应当开中断，CPU只有在执行开中断指令后面的一条指令CPU才重新开中断，一般这条指令是返回指令RET，它把断点的CS IP内容弹出，CPU之后开中断。
 
## 2.1 8086的中断系统
8086可以处理256种不同给的中断请求，按照中断源来自CPU内部和外部一般可以分为: 外部中断源和内部中断源, 对应的中断称为外部中断和内部中断。

**外部中断源**即为硬件中断源,来自CPU的外部,8086有两个引脚, INTR引脚接受可屏蔽中断请求的信号,NMI引脚接受不可屏蔽中断请求信号。

**内部中断源**是来自CPU内部的中断事件,这些事情是特定的事情:

1. 除法错误,除0或者商超过了最大值,CPU会自动产生类型为0的除法错误中断
2. 软件中断, 8086 系统中有三条中断指令,(1) int n 产生一个类型为n的中断 (2) int 3 : 断点中断 (3) into: 溢出标志位OF为1，执行into后将会产生类型4的溢出中断
3. 单步中断: 当FLAGS的标志位TF=1,8086处于单步工作的方式,CPU每执行一条指令，自动产生类型为1的单步中断

**中断优先级**: 8086将所有中断请求划分为四级,0级最高
1. 0级: 除单步中断以外的所有内部中断
2. 1级: 不可屏蔽中断
3. 2级: 可屏蔽中断
4. 3级: 单步中断

## 2.2 中断类型号与向量表
CPU响应中断的时候, 需要进行中断源的判断，从而决定调用哪个中断服务函数，每个中断源有一个唯一的编号:中断类型号,因此CPU根据当前中断源的中断类型号来决定调用的中断服务函数。

1. 可屏蔽中断(硬件中断): 可屏蔽中断向CPU发送中断请求信号，经过8259A管理, 当CPU准备响应中断请求的时候, 会给8259A发送一个中断响应信号,8259A接受到后，会把中断申请外设的中断类型号送上数据总线发送给CPU.

2. 软件中断: int n. n 就是中断类型号

3. 其余情况都是固定的中断类型号，例如除法错(0)，单步中断(1),断点中断(3),溢出中断(4),外部的不可屏蔽中断(2)

8086系统总共有256个中断源,类型号从0~FFH

**中断向量表**: 中断服务程序的入口地址存放在一段称为中断向量表的连续地址中。 00000H~003FFH, 每个中断服务函数入口地址占4个字节，前两个字节是偏移量，后两个字节的地址是段基址,总共1K字节。 例如, 类型32的中断的入口地址存放在: 32*4 = 8*16= 80H.

 
