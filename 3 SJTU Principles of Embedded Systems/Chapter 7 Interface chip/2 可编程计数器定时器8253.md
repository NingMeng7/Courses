## 1. 可编程计数器/定时器8253及其应用
粗略的延迟可以用delay子函数循环nop来实现，但是这种延时不太精确，并且在执行延时的时候占用了CPU资源，硬件定时的方法是利用专门的硬件定时/计数器,在简单软件控制下实现准确的延时时间, 程序简单，几乎不占用CPU资源，通用性强。

具体地说，通过软件对计时器设置计数初值、方式并启动计数器，当计数到定值的时候，自动产生定时信号，一般计数是根据时钟脉冲，由于时钟准确度高，这种计数误差很小。

8253是16位的可编程定时/计数器:

1. 每片8253有三个独立的16位计数通道
2. 每个计数器可以按照2进制或者10进制来计数
3. 每个计数器的最高计数速率可以达到2.6MHz
4. 每个计数器都可以编程设定为6种工作方式之一
5. 所有输入输出均和TTL电平兼容，便于和外围接口电路相连

每个计数器的内部都包含有一个计数初值寄存器、一个减1计数寄存器、一个当前计数输出寄存器和一个控制寄存器。

## 2. 8253 启动
软件启动: 指的是CPU用输出指令向计数器写入初值后就启动计数，由于实际上写入的是初值寄存器，需要在下一个CLK下降沿才送到计数器，因此有一个脉冲误差，实际上需要N+1个脉冲才能产生一个OUT信号。

硬件启动：写入计数初值后不启动计数，直到门控信号GATE由低电平变高之后才开始计数，由于CLK采样和门控信号变高不一定同步，极端情况下也会差一个CLK。

对于周期重复的计数，在稳定的情况下，这个误差不再存在。

## 3. 8253的六种计数方式
1. 不重复的技术方式: 计数器每启动一次只工作一个周期
2. 自动重复的计数方式: 一旦计数启动，只要门控信号GATE保持高电平，计数过程就会自动周而复始地重复下去，此时OUT端将会产生连续地波形
3. 在自动重复计数地方式下，稳定状态后，启动时造成地实际计数值和计数初值之间地误差不再存在

> 0. 方式0 (计数结束产生中断)

1. 在计数器减为0之前,OUT维持低电平,计数器减到0时,OUT变为高电平,并保持到重新写入新的控制字/计数值为止。
2. 计数过程中如果GATE变为低电平，则暂停计数，直到GATE变高。
3. 计数过程中如果写入新的计数初值，则在下一个CLK下降沿减1计数寄存器以新的计数初值重新开始计数过程。

> 1. 方式1 (可重触发的单稳态方式)
1. 特点是输出单个负脉冲信号，脉冲宽度可以编程设定。
2. 写入控制字后OUT变为高电平并保持，然后写入计数值，在GATE信号上升沿后的下一个CLK脉冲的下降沿将计数初值寄存器内容写入减1计数寄存器,同时OUT变为低电平，计数值减为0时，OUT变为高电平。
3. 如果计数过程又来一个GATE上升沿，则重新把计数初值寄存器中内容写到减1寄存器，重新计数，OUT保持低电平。
4. 计数过程CPU送来新的计数初值不影响当前计数过程，一直等到下次GATE上升沿才会重新装入新的计数初值。

> 2. 方式2 (频率发生器)
1. 特点是产生连续的负脉冲信号, 负脉冲的宽度是一个时钟周期
2. 写入控制字后, OUT变为高电平，如果GATE为高电平，当写入计数初值后，下一个CLK下降沿将计数初值寄存器内容写入减一计数寄存器开始减1计数，当减1计数寄存器的值为1，OUT输出低电平，经过一个CLK周期,OUT输出高电平，**并开始一个新的计数过程**。
3. 如果减1计数器没减到1，GATE变低，则停止计数，但是GATE从低变高，会重新将计数初值寄存器内容装入减1计数寄存器，并且重新开始计数。

> 3. 方式3 (方波发生器)
1. 特点是输出是一个方波信号
2. 控制字写入后,OUT输出高电平，写入计数初值后，在下一个CLK下降沿将计数初值寄存器内容写入减一计数寄存器开始减1计数，当计数到一半的时候，OUT变低电平，计数到0，OUT变高电平，之后**周而复始地自动进行计数过程**，当计数初值为偶数，输出对称方波，否则输出不对称方波。
3. 如果计数过程中，GATE变低，则停止计数,GATE变高重新启动计数过程。如果输出为低电平的时候GATE变低，计数停止，OUT**在下一个CLK下降沿**立刻变高，GATE变高后，下一个CLK下降沿，重新写入计数初值，重新开始减1计数。
4. 计数过程如果写入新的计数值，不影响当前周期，但是，如果写入新的初值后，受到门控信号上升沿触发，就会在下一个CLK下降沿重新得到计数初值进行计数。

> 4. 方式4 (软件触发的选通信号发生器)
1. 产生单个负脉冲信号，宽度为一个时钟周期。
2. 写入控制字后,OUT变高，如果GATE为高，写入计数初值后，在下一个CLK下降沿将计数初值寄存器内容写入减一计数寄存器开始减1计数，当减1计数寄存器值为0，OUT变低电平，经过一个CLK周期，OUT输出高电平。
3. 计数的时候写入新的计数值，在下一个CLK下降沿这个计数初值被写入减1计数寄存器，以新的计数值作减1计数。

> 5. 方式5 (硬件触发的选通信号发生器)
1. 由GATE上升沿触发。
2. 控制字写入后,OUT输出高电平并保持，写入计数初值，在GATE信号上升沿的下一个CLK下降沿，将计数初值写入减一计数寄存器开始减一计数，计数值到0的时候，OUT变低，持续一个CLK周期后变为高电平。
3. 如果计数过程中,GATE又来一个上升沿触发，则在下一个CLK下降沿重新写入计数初值重新开始计数
4. 如果写入新的计数初值，但没有GATE触发脉冲，则当前输出周期不影响，在下一次GATE上升沿才以新的初值开始计数

## 4. 8253的计数方式
8253有二进制计数和BCD计数两种方式, 差别是二进制计数范围为0000H～FFFFH，十进制是0000～9999, **当一个通道的计数初值范围不够用的时候,可以让一个通道产生方波信号,作为另一个通道的CLK**

假设计数初值是十进制的25, 采用二进制计数应当写入19H,或者写入25D,采用BCD码计数的话应该写入25H，因为BCD码的25H就是十进制的25.

更多的例子: 
1. BCD码计数,初值是1234D,写入的就是1234H
2. 二进制计数,初值是18D, 写入 18D


## 5. 8253的初始化
1. 写入方式控制字: 三个通道的控制字端口相同，写入后存在对应的寄存器中
2. 写入计数初值(只谢低位，还是只写高位，或者先低后高都写要根据控制字来)
3. 读计数值(计时)
        
1. 计数初值 = f(CLK)/f(OUT)
2. 

        假设: 要用8253的0计数器作为十进制计数器，输入100KHz的CLK，输出1KHz的方波
        #0: 210H #1:211H #2:212H 控制端:213H
        计数值应该为100
        控制字应该为 00 11 011 1B
        MOV AL, 37H
        MOV DX, 213H
        OUT DX, AL
        MOV DX, 210H
        MOV AL, 00H
        OUT DX, AL
        MOV AL, 01h ;   按BCD码计数！
        OUT DX, AL
        
        假设: 8253端口地址3F0H~3F3H,要求通道0工作在方式3，计数初值为1234
        MOV AL, 00110111B
        MOV DX, 3F3H
        OUT DX, AL
        MOV DX, 3F0H
        MOV AL, 34H
        OUT DX, AL
        MOV AL, 12H
        OUT DX, AL
        
        MOV AL, 00000111B
        MOV DX, 3F3H
        OUT DX, AL
        MOV DX, 3F0H
        IN AL, DX   ; 读低字节
        MOV AH, AL
        IN AL, DX   ; 读高字节
        XCHG AH, AL
        MOV CX, 1234+1
        SUB CX, AX
  
        例如: 3个计数器CLK均为2M,要求计数器0在100us后中断请求，计数器1产生10us对称方波，计数器2每1ms产生一个负脉冲
        1/2M * f = T
        INIT8253:
        MOV DX, 0FF07H
        MOV AL, 10H ;   计数器0,只写低八位，方式0，二进制计数
        OUT DX, AL
        MOV AL, 56H ;   计数器1,只写低八位，方式3，二进制计数
        OUT DX, AL
        MOV AL, 0B4H;   计数器2，先写高8位后写低8位，方式2，二进制计数
        OUT DX, AL
        MOV DX, 0FF04H
        MOV AL, 200
        OUT DX, AL
        MOV DX, 0FF05H
        MOV AL, 20
        OUT DX, AL
        MOV DX, 0FF06H
        MOV AX, 2000
        OUT DX, AL
        MOV AL, AH
        OUT DX, AL

